<!DOCTYPE html>
<html lang="en">

<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>MNW</title>
    <!-- plugins:css -->
    <link rel="stylesheet" href="../../vendors/feather/feather.css">
    <link rel="stylesheet" href="../../vendors/ti-icons/css/themify-icons.css">
    <link rel="stylesheet" href="../../vendors/css/vendor.bundle.base.css">
    <!-- endinject -->
    <!-- Plugin css for this page -->
    <!-- End plugin css for this page -->
    <!-- inject:css -->
    <link rel="stylesheet" href="../../vendors/datatables.net-bs4/dataTables.bootstrap4.css">
    <link href="https://cdn.datatables.net/v/dt/dt-1.13.6/datatables.min.css" rel="stylesheet">

    <link rel="stylesheet" href="../../vendors/select2/select2.min.css">
    <link rel="stylesheet" href="../../vendors/select2-bootstrap-theme/select2-bootstrap.min.css">
    <link rel="stylesheet" href="../../css/vertical-layout-light/style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css"
        integrity="sha512-..." crossorigin="anonymous" />

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <!-- endinject -->
    <link rel="shortcut icon" href="../../images/logo/m-favicon.png" />
    <link rel="stylesheet" href="../../js/multiselct/select1_13_18.css">
  
    
</head>

<body>
    <div class="container-scroller">
        <!-- partial:../../partials/_navbar.html -->
        <!-- <div id="navbarPlaceholder"></div> -->
        <div id="navbar-container"></div>
        

        <!-- partial -->
        <div class="container-fluid page-body-wrapper">
            <!-- partial:../../partials/_settings-panel.html -->
            <!-- <div id="topbar"></div> -->
            <div id="sidbar-container"></div>



            <!-- partial -->
            <!-- <div id="menubar"></div> -->
            
            <!-- partial -->
            <div class="main-panel">
                <div class="content-wrapper">
                    <div class="card">
                        <div class="card-body">
                            <h3 class="text-primary">Duplicate Viewer</h3>
                            <hr>
                            <br>
                            <div id="loader" class="spinner-border text-primary" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
            
                            <!-- Form Section -->
                            <div id="message">
                                <div class="row">
                                    <div class="col-md-5">
                                        <label>Project Name :</label>
                                        <div class="project_list_item"></div>
                                    </div>

                                    <div class="col-md-5">
                                        <label>Find Duplicate Project Name :</label>
                                        <div class="Duplicate_project_list_item"></div>
                                    </div>

            
                                    <!-- Select Option 1 Column -->
                                    <div class="col-md-5">
                                        <label>Cycle Name :</label>
                                        <div class="cycle_list_item"></div>
                                        <!-- <select id="select1" name="select1" class="form-control">
                                            <option value="">-- Choose --</option>
                                        </select> -->
                                    </div>
            
                                    <!-- Select Option 2 Column -->
                                    <div class="col-md-5">
                                        <label for="select2">Find Duplicate Cycle Name</label>
                                        <div class="Duplicate_cycle_list_item"></div>
                                        <!-- <select id="select2" name="select2" class="selectpicker form-control" data-live-search="true">
                                            <option value="">-- Choose --</option>
                                        </select> -->
                                    </div>
            
                                    <!-- Submit Button Column -->
                                    <div class="col-md-2 ">
                                        <div class="mt-4 text-center">
                                            <button type="button" id="submitBtn" class="btn btn-primary">Submit</button>
                                        </div>
                                    </div>
            
                                </div>
                            </div>

                        </div>
            
                        <!-- Style Section -->
                        <style>
                            select[name="my_table_length"] {
                                width: 60px;
                                display: inline-block;
                                height: 30px;
                            }
            
                            #my_table1 {
                                font-size: 16px;
                            }
            
                            #my_table1 th {
                                font-size: 18px;
                                text-align: center;
                            }
            
                            #my_table1 td {
                                font-size: 15px;
                            }
                        </style>
                    </div>

                    <div id="messageBox" class="alert mt-3" style="display: none;"></div>
                    <br>
                    
                    <div class="card" id="imgCard" style="display: none;">
                        <br>
                        <div class="card-body">
                            <div class="container">
                                <div class="row" id="imageRow">

                                </div>
                            </div>
                        </div>
                    </div>

                    <br>
                </div>
            </div>
            
            <!-- main-panel ends -->
        </div>
        <!-- page-body-wrapper ends -->
    </div>

    <style>
        select[name="my_table1_length"] {
            height: 30px;
        }

        .paginate_button {
            font-size: 12px;
        }
    </style>
 <style>
    #loader {
        display: none;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 9999;

        border-radius: 50%;
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        0%   { transform: translate(-50%, -50%) rotate(0deg); }
        100% { transform: translate(-50%, -50%) rotate(360deg); }
    }
</style>

    <!-- container-scroller -->
    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>


    <script src="../../vendors/datatables.net-bs4/dataTables.bootstrap4.js"></script>
    <script src="../../vendors/datatables.net/jquery.dataTables.js"></script>
    <script src="../../js/dataTables.select.min.js"></script>
    <link rel="stylesheet" href="../../vendors/datatables.net-bs4/dataTables.bootstrap4.css">
    <script src="../../vendors/js/vendor.bundle.base.js"></script>
    <!-- <script src="../../vendors/select2/select2.min.js"></script> -->
    <!-- <script src="../../js/off-canvas.js"></script> -->
    <script src="../../js/hoverable-collapse.js"></script>
    <script src="../../js/settings.js"></script>
    <script src="../../js/todolist.js"></script>
    <script src="../../js/select2.js"></script>
</body>
<script src="../../js/url.js"></script>
<script src="../../js/auth-setup.js"></script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">



<script>
    $(document).ready(function () {
       
        loadNavbar();
        loadsidbar();
    });
</script>
<!-- 
<script>
    $(document).ready(function () {
        var url = baseurl + '/dup';

        // Show the loader before the AJAX request
        $("#loader").show();

        $.ajax({
            url: url,
            type: 'POST',
            contentType: 'application/json',
            success: function (response) {
                console.log('Request successful');
                console.log('Response:', response);

                // Hide the loader
                $("#loader").hide();

                // Show the success message
                $("#message").show().text('Request successful');
            },
            error: function (xhr, status, error) {
                console.error('Error:', error);

                // Hide the loader
                $("#loader").hide();

                // Show the error message
                $("#message").show().text('Request failed').removeClass('alert-success').addClass('alert-danger');
            }
        });
    });
</script> -->

<script src="../../js/url.js"></script>
<script src="../../js/multiselct/popper.js"></script>
  <!-- Bootstrap-select JS -->
  <script src="../../js/multiselct/4select_1_13_18.js"></script>
<script>

const token = localStorage.getItem('token');
const hostname = window.location.hostname;

// Initialize selectpickers
$('.selectpicker').selectpicker('refresh');

// Fetch projects
fetch(`${baseurl}/get_project`, {
    headers: {
        "Content-Type": "application/json",
        'Authorization': `Bearer ${token}`
    }
})
.then(response => {
    if (!response.ok) {
        throw new Error(`HTTP error! Status: ${response.status}`);
    }
    return response.json();
})
.then(projects => {
    console.log("Fetched projects:", projects);

    const $projectContainer1 = $('.project_list_item');
    const $projectContainer2 = $('.Duplicate_project_list_item');
    $projectContainer1.empty();
    $projectContainer2.empty();

    const $projectSelect1 = $('<select>')
        .addClass('selectpicker form-control w-100 project-select')
        .attr({
            id: "projectSelect1",
            name: "projectSelect1",
            'data-live-search': 'true',
            title: 'Select Project',
            multiple: false
        });
    
    const $projectSelect2 = $('<select>')
        .addClass('selectpicker form-control w-100 project-select')
        .attr({
            id: "projectSelect2",
            name: "projectSelect2",
            'data-live-search': 'true',
            title: 'Select Duplicate Project',
            multiple: false
        });

    // Add default option
    $projectSelect1.append($('<option>').val('').text('-- Select Project --'));
    $projectSelect2.append($('<option>').val('').text('-- Select Project --'));

    projects.forEach(project => {
        $projectSelect1.append($('<option>').val(project.project_id).text(project.project_name));
        $projectSelect2.append($('<option>').val(project.project_id).text(project.project_name));
    });
    
    $projectContainer1.append($projectSelect1);
    $projectContainer2.append($projectSelect2);
    
    $projectSelect1.selectpicker('refresh');
    $projectSelect2.selectpicker('refresh');

    // Add event listeners to project selects to load cycles when a project is selected
    $projectSelect1.on('changed.bs.select', function(e) {
        const projectId = $(this).val();
        populateCycleData(projectId, 'cycleSelect1');
    });

    $projectSelect2.on('changed.bs.select', function(e) {
        const projectId = $(this).val();
        populateCycleData(projectId, 'cycleSelect2');
    });
})
.catch(error => {
    console.error("Error fetching projects:", error);
});

// Initialize cycle dropdowns
const $cycleContainer1 = $('.cycle_list_item');
const $cycleContainer2 = $('.Duplicate_cycle_list_item');
$cycleContainer1.empty();
$cycleContainer2.empty();

const $cycleSelect1 = $('<select>')
    .addClass('selectpicker form-control w-100 cycle-select')
    .attr({
        id: "cycleSelect1",
        name: "cycleSelect1",
        'data-live-search': 'true',
        title: 'Please select a project first',
        multiple: false
    });

const $cycleSelect2 = $('<select>')
    .addClass('selectpicker form-control w-100 cycle-select')
    .attr({
        id: "cycleSelect2",
        name: "cycleSelect2",
        'data-live-search': 'true',
        title: 'Please select a project first',
        multiple: false
    });

// Initially disable cycle dropdowns
$cycleSelect1.prop('disabled', true);
$cycleSelect2.prop('disabled', true);

$cycleContainer1.append($cycleSelect1);
$cycleContainer2.append($cycleSelect2);

$cycleSelect1.selectpicker('refresh');
$cycleSelect2.selectpicker('refresh');

// Function to populate cycle data based on selected project
function populateCycleData(projectId, targetSelectId) {
    const $targetSelect = $(`#${targetSelectId}`);
    
    if (!projectId) {
        // No project selected - disable cycle dropdown
        $targetSelect.empty();
        $targetSelect.prop('disabled', true);
        $targetSelect.attr('title', 'Please select a project first');
        $targetSelect.selectpicker('refresh');
        return;
    }
    
    // Create FormData and send request
    const formData = new FormData();
    formData.append('project_id', projectId);

    fetch(`${baseurl}/get_cycle`, {
        method: 'POST',
        headers: {
            'Authorization': `Bearer ${token}`
        },
        body: formData
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
        return response.json();
    })
    .then(cycles => {
        console.log("Fetched cycles for project:", cycles);
        
        // Enable cycle dropdown and populate with cycles
        $targetSelect.empty();
        $targetSelect.prop('disabled', false);
        $targetSelect.attr('title', 'Select Cycle');
        
        // Add default option
        $targetSelect.append($('<option>').val('').text('-- Select Cycle --'));
        
        // Add cycles for the selected project
        if (cycles.length === 0) {
            $targetSelect.append($('<option>').val('').text('No cycles available').prop('disabled', true));
        } else {
            cycles.forEach(cycle => {
                $targetSelect.append($('<option>')
                    .val(cycle.cycle_id)
                    .text(cycle.cycle_name));
            });
        }
        
        $targetSelect.selectpicker('refresh');
    })
    .catch(error => {
        console.error("Error fetching cycles:", error);
        $targetSelect.empty();
        $targetSelect.append($('<option>').val('').text('Error loading cycles').prop('disabled', true));
        $targetSelect.selectpicker('refresh');
    });
}

// Add click event to show message if trying to select cycle without project
$(document).on('show.bs.select', '.cycle-select', function(e) {
    const selectId = $(this).attr('id');
    const correspondingProjectId = $('#projectSelect1').val();
        
    if (!correspondingProjectId) {
        // Prevent the dropdown from opening
        e.preventDefault();
        $(this).selectpicker('toggle');
        
        // Show message
        Swal.fire({
            title: "Select Project First",
            text: "Please select a project before choosing a cycle.",
            icon: "info",
        });
    }
});
// Update submit button event handler
document.getElementById("submitBtn").addEventListener("click", function() {
    const project1Value = document.getElementById("projectSelect1").value;
    const project2Value = document.getElementById("projectSelect2").value;
    const cycle1Value = document.getElementById("cycleSelect1").value;
    const cycle2Value = document.getElementById("cycleSelect2").value;

    if (project1Value && project2Value && cycle1Value && cycle2Value) {
        // Show loader
        console.log(project1Value, project2Value, cycle1Value, cycle2Value);
        document.getElementById("loader").style.display = "inline-block";
        

            const messageBox = document.getElementById("messageBox");
            const imgCard = document.getElementById("imgCard");
            messageBox.style.display = "block";
            imgCard.style.display = "none"; 
            messageBox.className = "alert mt-3";
            

            const url = `${baseurl}/getting_duplicates_based_on_cycle`;
            $.ajax({
                url: url,
                type: 'POST',
                data: {
                    original_cycle_id: cycle1Value,
                    duplicate_cycle_id: cycle2Value
                },
                headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` },
                success: function (response) {
                    console.log("Request successful");
                    console.log("Response:", response);

                    const $imageRow = $('#imageRow');
                    $imageRow.empty(); 

                    if (response.length === 0) {
                        const messageCard = `
                            <div class="col-12">
                                <div class="card text-center">
                                    <div class="card-body">
                                        <h5 class="card-title" style="color: red;">No Duplicates Found</h5>
                                    </div>
                                </div>
                            </div>`;
                        $imageRow.append(messageCard);
                        document.getElementById("loader").style.display = "none";
                        return;
                    }

                    messageBox.classList.add("alert-warning");
                    messageBox.innerText = "Duplicates fetching...";
                    // Lazy load setup
                    let allDuplicates = response;
                    let currentIndex = 0;
                    const batchSize = 5;

                    function loadDuplicateBatch() {
                        const nextBatch = allDuplicates.slice(currentIndex, currentIndex + batchSize);

                        nextBatch.forEach(item => {
                            const originalImagePath = item.original_image_path.replace('upload_image', baseurl + '/image');
                            const duplicateImagePath = item.duplicate_image_path.replace('upload_image', baseurl + '/image');

                            const originalCol = $('<div class="col-md-6 mb-4"></div>');
                            const duplicateCol = $('<div class="col-md-6 mb-4"></div>');

                            const originalImg = $('<img>', {
                                src: originalImagePath,
                                alt: 'Original Image',
                                loading: 'lazy',
                                style: 'max-width:100%; border-radius:6px;'
                            });

                            const duplicateImg = $('<img>', {
                                src: duplicateImagePath,
                                alt: 'Duplicate Image',
                                loading: 'lazy',
                                style: 'max-width:100%; border-radius:6px;'
                            });

                            originalCol.append(`<p style="color:red;font-weight:bold;">Original Image Path: ${item.original_image_path}</p>`);
                            originalCol.append(originalImg);
                            duplicateCol.append(`<p style="color:red;font-weight:bold;">Duplicate Image Path: ${item.duplicate_image_path}</p>`);
                            duplicateCol.append(duplicateImg);

                            $imageRow.append(originalCol);
                            $imageRow.append(duplicateCol);
                        });

                        currentIndex += batchSize;

                        if (currentIndex >= allDuplicates.length) {
                            $('#loadMoreBtn').hide();
                        }
                    }

                    loadDuplicateBatch();

                    // Add "Load More" button
                    if (response.length > batchSize) {
                        const $loadMoreBtn = $('<div class="text-center mt-4"><button id="loadMoreBtn" class="btn btn-outline-primary">Load More</button></div>');
                        $imageRow.after($loadMoreBtn);
                        $('#loadMoreBtn').on('click', loadDuplicateBatch);
                    }

                    const observer = new IntersectionObserver(entries => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting && currentIndex < allDuplicates.length) {
                                loadDuplicateBatch();
                            }
                        });
                    });
                    observer.observe(document.querySelector('#imageRow'));
                    messageBox.style.display = "none"; // hide message box
                    imgCard.style.display = "block"; // show image card
                    document.getElementById("loader").style.display = "none";
                },
                error: function (xhr, status, error) {
                    console.error('Error:', error);
                    document.getElementById("loader").style.display = "none";
                }
            });

        } else {
            messageBox.classList.add("alert-success");
            messageBox.innerText = "No duplicates found.";
        }
    })
    .catch(error => {
        console.error("Error submitting cycles:", error);
        document.getElementById("loader").style.display = "none";

        const errorBox = document.createElement("div");
        errorBox.className = "alert alert-danger mt-3";
        errorBox.innerText = "There was an error submitting the cycles.";
    });


</script>

    <script src="../../js/template.js"></script>

</html>